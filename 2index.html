<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ãƒªã‚¢ãƒ«é€†è»¢è£åˆ¤ â€” ä¸‰å¯©åˆ¶ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰</title>

<!-- Google Font: Noto Sans JP (html2pdf will rasterize DOM so font renders in PDF) -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#f6f8fb; --card:#fff; --accent:#1a73e8; --muted:#6b7280;
  }
  html,body{height:100%;margin:0;font-family:"Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",Meiryo,sans-serif;background:var(--bg);color:#071029}
  .container{max-width:820px;margin:8px auto;padding:10px}
  header{display:flex;align-items:center;justify-content:space-between;gap:8px}
  h1{font-size:18px;margin:0;color:var(--accent)}
  .flex{display:flex;gap:8px}
  .card{background:var(--card);border-radius:12px;padding:12px;margin-top:10px;box-shadow:0 6px 18px rgba(13,18,25,0.04)}
  label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
  textarea, input, select {width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef6;font-size:15px;box-sizing:border-box}
  button{width:100%;padding:12px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-size:16px;cursor:pointer}
  .btn-ghost{background:#fff;color:var(--accent);border:1px solid #dbe9ff}
  .row{display:flex;gap:8px}
  .row > *{flex:1}
  #log{min-height:160px;max-height:320px;overflow:auto;padding:10px;border-radius:8px;border:1px solid #eef6ff;background:#fcfeff;white-space:pre-wrap}
  .small{font-size:13px;color:var(--muted)}
  .stage-indicator{font-weight:700;color:#0f1724;margin-top:6px}
  .prediction-buttons button{width:48%}
  footer{margin-top:10px;text-align:center;color:var(--muted);font-size:13px}
  @media (prefers-color-scheme: dark){
    :root{--bg:#0b1220;--card:#071028;--accent:#4ea1ff;--muted:#8b98a9}
    textarea,input,select{background:#0b1220;color:#e6eef6;border-color:#123}
    #log{background:#071028;color:#dbe9ff;border-color:#123}
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>ãƒªã‚¢ãƒ«é€†è»¢è£åˆ¤ï¼ˆã‚¹ãƒãƒ›å¯¾å¿œï¼‰</h1>
    <div class="small">ä¸‰å¯©åˆ¶ãƒ»PDFå‡ºåŠ›ãƒ»ç™ºè¨€ãƒ­ã‚°ã‚’ä¿å­˜</div>
  </header>

  <!-- Case editor -->
  <section class="card" aria-labelledby="case">
    <div style="display:flex;gap:8px;align-items:center;">
      <div style="flex:1">
        <label>äº‹ä»¶æ¦‚è¦ï¼ˆæ‰‹å‹•å…¥åŠ›ã¾ãŸã¯ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆï¼‰</label>
        <textarea id="caseInput" rows="3" placeholder="ä¾‹ï¼šå¤œé–“æ¨ªæ–­ä¸­ã®æ­©è¡Œè€…ãŒè‡ªè»¢è»Šã¨è¡çªã—è² å‚·ã€‚åŸå‘Šã¯æå®³è³ å„Ÿ100ä¸‡å††ã‚’è«‹æ±‚ã€‚"></textarea>
      </div>
      <div style="width:110px">
        <label>&nbsp;</label>
        <button id="randCaseBtn" class="btn-ghost">ğŸ² ãƒ©ãƒ³ãƒ€ãƒ </button>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <button id="startBtn">âš–ï¸ è£åˆ¤é–‹å§‹ï¼ˆç¬¬ä¸€å¯©ï¼‰</button>
      <button id="autoFullBtn" class="btn-ghost">âš™ï¸ ä¸‰å¯©ã‚’è‡ªå‹•é€²è¡Œ</button>
    </div>

    <div class="small" style="margin-top:8px">ç¾åœ¨ã®å¯©ç´š: <span id="stageLabel">æœªé–‹å§‹</span></div>
  </section>

  <!-- Controls -->
  <section class="card">
    <div class="row">
      <div>
        <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®äºˆæƒ³ï¼ˆã“ã®å¯©ç´šï¼‰</label>
        <div class="prediction-buttons" style="display:flex;gap:6px">
          <button id="predPla">åŸå‘Šå‹è¨´</button>
          <button id="predDef" class="btn-ghost">è¢«å‘Šå‹è¨´</button>
        </div>
      </div>
      <div>
        <label>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</label>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button id="objBtn" class="btn-ghost">ğŸ™‹ ç•°è­°ã‚ã‚Šï¼ˆå…¥åŠ›ï¼‰</button>
          <button id="commentBtn" class="btn-ghost">ğŸ“ è‡ªç”±æ„è¦‹ã‚’å…¥åŠ›</button>
        </div>
      </div>
    </div>

    <div style="margin-top:10px">
      <label>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ­ã‚°ï¼ˆæ™‚ç³»åˆ—ï¼‰</label>
      <div id="playerLog" style="min-height:80px;padding:8px;border-radius:8px;border:1px solid #eef6ff;background:#fbfdff"></div>
    </div>
  </section>

  <!-- Trial cards -->
  <section class="card">
    <div class="small">å¯©ç´šè¡¨ç¤ºï¼ˆã‚¿ãƒƒãƒ—ã§åˆ‡æ›¿ï¼‰</div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="show1" class="btn-ghost">ç¬¬ä¸€å¯©</button>
      <button id="show2" class="btn-ghost">æ§è¨´å¯©</button>
      <button id="show3" class="btn-ghost">ä¸Šå‘Šå¯©</button>
    </div>

    <div id="trialArea" style="margin-top:12px">
      <!-- dynamic content inserted here -->
    </div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="nextStageBtn">â¡ï¸ æ¬¡ã®å¯©ç´šã¸é€²ã‚€</button>
      <button id="exportBtn" class="btn-ghost">ğŸ“„ åˆ¤æ±ºPDFã‚’å‡ºåŠ›</button>
    </div>
  </section>

  <!-- Log -->
  <section class="card">
    <div class="small">è£åˆ¤ãƒ­ã‚°ï¼ˆé€²è¡Œï¼è£åˆ¤æ‰€ãƒ¡ãƒ¢ï¼‰</div>
    <div id="log"></div>
  </section>

  <footer>æ³¨ï¼šã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯æ•™è‚²ãƒ»ã‚²ãƒ¼ãƒ ç›®çš„ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚ç”Ÿæˆã•ã‚Œã‚‹æ–‡æ›¸ã¯æ³•çš„åŠ©è¨€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</footer>
</div>

<!-- html2pdf (includes html2canvas + jsPDF) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<script>
/* ============================
   Trial system (Client-side)
   ============================ */

const state = {
  case: null,             // {id,title,summary,type,laws,precs,evidence}
  stage: 0,               // 0=not started, 1=first,2=appeal,3=final
  records: {},            // per-stage array of records
  verdicts: {},           // per-stage verdict {winner,headline,fullText}
  player: {               // player data
    predictions: {},      // stage -> 'plaintiff'|'defendant'
    actions: [],          // [{stage, type:'objection'|'comment', text, time}]
    score: 0
  },
  autoRunning: false
};

/* ---------- utilities ---------- */
function $(id){return document.getElementById(id);}
function now(){return new Date().toLocaleString();}
function randName(){ const fn=['ä½è—¤','éˆ´æœ¨','é«˜æ©‹','ç”°ä¸­','æ¸¡è¾º']; const gn=['å¤ªéƒ','èŠ±å­','ä¸€éƒ','å½©']; return fn[Math.floor(Math.random()*fn.length)] + ' ' + gn[Math.floor(Math.random()*gn.length)]; }
function randCourt(){ const c=['æ±äº¬åœ°æ–¹è£åˆ¤æ‰€','å¤§é˜ªåœ°æ–¹è£åˆ¤æ‰€','åå¤å±‹åœ°æ–¹è£åˆ¤æ‰€']; return c[Math.floor(Math.random()*c.length)]; }
function log(msg, cls='') {
  const el = $('log');
  const entry = document.createElement('div');
  entry.style.marginBottom='8px';
  entry.innerHTML = `<div style="font-size:12px;color:#94a3b8">${now()}</div><div>${msg}</div>`;
  el.prepend(entry);
}

/* ---------- UI wiring ---------- */
$('randCaseBtn').addEventListener('click', ()=> {
  const templates = [
    {type:'civil', title:'è·¯ä¸Šè‡ªè»¢è»Šè¡çªäº‹ä»¶', summary:'å¤œé–“ã«æ¨ªæ–­ä¸­ã®æ­©è¡Œè€…ãŒè‡ªè»¢è»Šã¨è¡çªã—è² å‚·ã€‚åŸå‘Šã¯æå®³è³ å„Ÿ100ä¸‡å††ã‚’è«‹æ±‚ã€‚è¢«å‘Šã¯å¤œé–“è¦–èªå›°é›£ãŠã‚ˆã³åŸå‘Šéå¤±ã‚’ä¸»å¼µã€‚'},
    {type:'criminal', title:'é£²é…’é‹è»¢è‡´å‚·äº‹ä»¶', summary:'è¢«å‘ŠãŒé£²é…’é‹è»¢ã«ã‚ˆã‚Šæ­©è¡Œè€…ã‚’è½¢ãé‡å‚·ã‚’è² ã‚ã›ãŸã€‚æ¤œå¯Ÿã¯å±é™ºé‹è»¢è‡´å‚·ã‚’ä¸»å¼µã€‚è¢«å‘Šã¯é£²é…’é‡ã‚’äº‰ã†ã€‚'},
    {type:'administrative', title:'å»ºç¯‰ç¢ºèªå–æ¶ˆè¨´è¨Ÿ', summary:'è¡Œæ”¿åºãŒå»ºç¯‰ç¢ºèªã‚’å–ã‚Šæ¶ˆã—ãŸå‡¦åˆ†ã«ã¤ã„ã¦ã€ç”³è«‹è€…ãŒå–æ¶ˆè¨´è¨Ÿã‚’æèµ·ã€‚æ‰‹ç¶šé©æ­£ã¨è£é‡ã®ç¯„å›²ãŒäº‰ç‚¹ã€‚'}
  ];
  const pick = templates[Math.floor(Math.random()*templates.length)];
  $('caseInput').value = `${pick.title} â€” ${pick.summary}`;
});

/* Predictions */
$('predPla').addEventListener('click', ()=> makePrediction('plaintiff'));
$('predDef').addEventListener('click', ()=> makePrediction('defendant'));

function makePrediction(who){
  if(state.stage===0){ alert('ã¾ãšã¯è£åˆ¤é–‹å§‹ï¼ˆç¬¬ä¸€å¯©ï¼‰ã—ã¦ãã ã•ã„'); return; }
  state.player.predictions[state.stage] = who;
  updatePlayerLog();
  log(`<strong>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äºˆæƒ³ï¼ˆç¬¬${state.stage}å¯©ï¼‰:</strong> ${who==='plaintiff' ? 'åŸå‘Šå‹è¨´' : 'è¢«å‘Šå‹è¨´'}`);
}

/* Actions */
$('objBtn').addEventListener('click', ()=> {
  if(state.stage===0){ alert('å¯©ç†æœªé–‹å§‹ã§ã™'); return; }
  const text = prompt('ç•°è­°ã®ç†ç”±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆãã®ã¾ã¾PDFã«è¨˜éŒ²ã•ã‚Œã¾ã™ï¼‰');
  if(text){
    state.player.actions.push({stage:state.stage,type:'objection',text,time:new Date().toISOString()});
    updatePlayerLog();
    log(`<strong>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç•°è­°ï¼ˆç¬¬${state.stage}å¯©ï¼‰:</strong> ${text}`);
  }
});
$('commentBtn').addEventListener('click', ()=> {
  if(state.stage===0){ alert('å¯©ç†æœªé–‹å§‹ã§ã™'); return; }
  const txt = prompt('è‡ªç”±æ„è¦‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆãã®ã¾ã¾PDFã«è¨˜éŒ²ã•ã‚Œã¾ã™ï¼‰');
  if(txt){
    state.player.actions.push({stage:state.stage,type:'comment',text:txt,time:new Date().toISOString()});
    updatePlayerLog();
    log(`<strong>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ„è¦‹ï¼ˆç¬¬${state.stage}å¯©ï¼‰:</strong> ${txt}`);
  }
});

/* Start trial (first stage) */
$('startBtn').addEventListener('click', ()=> {
  if(!$('caseInput').value.trim()){ alert('äº‹ä»¶æ¦‚è¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  startTrial();
});

/* Auto full (three-stage) */
$('autoFullBtn').addEventListener('click', async ()=> {
  if(state.autoRunning){ state.autoRunning=false; $('autoFullBtn').innerText='âš™ï¸ ä¸‰å¯©ã‚’è‡ªå‹•é€²è¡Œ'; return; }
  if(!state.case) startTrial();
  state.autoRunning = true; $('autoFullBtn').innerText='â›” è‡ªå‹•åœæ­¢';
  for(let s=state.stage; s<=3; s++){
    if(!state.autoRunning) break;
    if(state.stage !== s) setStage(s);
    await runStageAuto(s);
    // short pause
    await new Promise(r=>setTimeout(r,700));
  }
  state.autoRunning=false; $('autoFullBtn').innerText='âš™ï¸ ä¸‰å¯©ã‚’è‡ªå‹•é€²è¡Œ';
});

/* Show stage buttons */
$('show1').addEventListener('click', ()=> renderTrialArea(1));
$('show2').addEventListener('click', ()=> renderTrialArea(2));
$('show3').addEventListener('click', ()=> renderTrialArea(3));

/* Next stage */
$('nextStageBtn').addEventListener('click', ()=> {
  if(state.stage===0){ alert('ã¾ãšè£åˆ¤ã‚’é–‹å§‹ã—ã¦ãã ã•ã„'); return; }
  if(state.stage < 3){ setStage(state.stage+1); runStageAuto(state.stage); }
  else alert('æ—¢ã«æœ€çµ‚å¯©ç´šã§ã™');
});

/* Export PDF */
$('exportBtn').addEventListener('click', exportAllVerdictsPDF);

/* ---------- core functions ---------- */

function startTrial(){
  state.case = {
    id: 'CASE' + Date.now().toString(36).slice(-6),
    title: $('caseInput').value.split('â€”')[0]?.trim() || 'ï¼ˆäº‹ä»¶ï¼‰',
    summary: $('caseInput').value.trim(),
    court: randCourt(),
    judge: randName()
  };
  state.stage = 1;
  state.records = {1:[],2:[],3:[]};
  state.verdicts = {};
  state.player.predictions = {};
  state.player.actions = [];
  state.player.score = 0;
  log(`<strong>äº‹ä»¶ç™»éŒ²:</strong> ${state.case.title}`);
  setStage(1);
  runStageAuto(1);
  renderTrialArea(1);
  updatePlayerLog();
}

/* set UI stage label */
function setStage(n){
  state.stage = n;
  $('stageLabel').innerText = (n===1?'ç¬¬ä¸€å¯©ï¼ˆåœ°æ–¹è£åˆ¤æ‰€ï¼‰':n===2?'æ§è¨´å¯©ï¼ˆé«˜ç­‰è£åˆ¤æ‰€ï¼‰':'ä¸Šå‘Šå¯©ï¼ˆæœ€é«˜è£åˆ¤æ‰€ï¼‰');
}

/* simulate stage automatically (CPU pseudo-AI) */
async function runStageAuto(stageNo){
  log(`=== ç¬¬${stageNo}å¯©ã®å¯©ç†ã‚’é–‹å§‹ã—ã¾ã™ ===`);
  const steps = [
    'è¨´çŠ¶ãƒ»èµ·è¨´ã®å‘ˆç¤º',
    'ç­”å¼æ›¸ãƒ»å¼è«–æº–å‚™',
    'è¨¼æ‹ é–‹ç¤ºãƒ»è¨¼æ‹ èª¿ã¹',
    'è¨¼äººå°‹å•ï¼ˆä»»æ„ï¼‰',
    'æœ€çµ‚å¼è«–',
    'è©•è­°'
  ];
  for(let i=0;i<steps.length;i++){
    // small simulated delay
    await new Promise(r=>setTimeout(r, Math.max(200, 800 - (i*60))));
    // CPU generates arguments for the step
    const outputs = cpuGenerateArguments(stageNo, steps[i]);
    state.records[stageNo].push({step:steps[i],outputs,time:new Date().toISOString()});
    log(`<strong>æ‰‹ç¶š:</strong> ${steps[i]}<br/><em>åŸå‘Šï¼š</em>${outputs.plaintiff}<br/><em>è¢«å‘Šï¼š</em>${outputs.defendant}<br/><em>è£åˆ¤æ‰€ãƒ¡ãƒ¢ï¼š</em>${outputs.judgeNotes}`);
  }
  // generate judgment for this stage
  const verdict = cpuJudgeDecision(stageNo);
  state.verdicts[stageNo] = verdict;
  log(`<strong>åˆ¤æ±ºï¼ˆç¬¬${stageNo}å¯©ï¼‰:</strong> ${verdict.headline}`);
  // evaluate player's prediction if any
  if(state.player.predictions[stageNo]){
    const pred = state.player.predictions[stageNo];
    const hit = (pred === verdict.winner);
    if(hit){ state.player.score += 1; log(`<strong>äºˆæƒ³çš„ä¸­ï¼ˆç¬¬${stageNo}å¯©ï¼‰ï¼</strong>`); } 
    else { log(`<strong>äºˆæƒ³ã¯å¤–ã‚Œï¼ˆç¬¬${stageNo}å¯©ï¼‰</strong>`); }
  } else {
    log(`ï¼ˆç¬¬${stageNo}å¯©ã«å¯¾ã™ã‚‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼äºˆæƒ³ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼‰`);
  }
  renderTrialArea(stageNo);
  updatePlayerLog();
}

/* CPU pseudo-AI for arguments */
function cpuGenerateArguments(stage, stepName){
  const base = state.case.summary || '';
  const plaintiff = (stage===1) ? `åŸå‘Šã¯${base}ã¨ä¸»å¼µã—ã€æå®³è³ å„Ÿã‚’æ±‚ã‚ã‚‹ã€‚` :
                    (stage===2) ? `è¢«æ§è¨´äººã¯ç¬¬ä¸€å¯©ã®äº‹å®Ÿèªå®šã«äº‰ã„ãŒã‚ã‚‹ã¨ä¸»å¼µã™ã‚‹ã€‚æ–°ãŸã«è¨¼æ‹ ã‚’æå‡ºã€‚` :
                                  `ä¸Šå‘Šã¯æ³•å¾‹åˆ¤æ–­ã«é™å®šã—ã¦äº‰ç‚¹ã‚’äº‰ã†ã€‚æ³•çš„äº‰ç‚¹ã‚’ä¸­å¿ƒã«ä¸»å¼µã€‚`;
  const defendant = (stage===1) ? `è¢«å‘Šã¯éå¤±ã‚’å¦èªã—ã€éå¤±ç›¸æ®ºã‚„å› æœé–¢ä¿‚ã‚’äº‰ã†ã€‚` :
                     (stage===2) ? `æ§è¨´äººã¯ç¬¬ä¸€å¯©ã®è¨¼æ‹ è©•ä¾¡ã‚’äº‰ã„ã€è¨¼æ‹ ã®ä¿¡ç”¨æ€§ã‚’æ”»æ’ƒã™ã‚‹ã€‚` :
                                   `ä¸Šå‘Šäººã¯æ³•è§£é‡ˆã®èª¤ã‚Šã‚’ä¸»å¼µã™ã‚‹ï¼ˆå…¬æ³•ä¸Šã®å•é¡Œï¼‰ã€‚`;
  const judgeNotes = `äº‰ç‚¹ä¾‹ï¼šéå¤±ã®æœ‰ç„¡ã€æå®³é¡ã€è¨¼æ‹ ã®ä¿¡ç”¨æ€§ã€‚éšç´šï¼šç¬¬${stage}å¯©ã€‚ã‚¹ãƒ†ãƒƒãƒ—ï¼š${stepName}`;
  return {plaintiff, defendant, judgeNotes};
}

/* CPU decision: naive but "å®Ÿå‹™å¯„ã›"ãƒ†ãƒ³ãƒ—ãƒ¬ã§å‡ºåŠ› */
function cpuJudgeDecision(stage){
  // simplistic scoring based on random + stage modifiers
  const rand = Math.random();
  let winner = rand > 0.45 ? 'defendant' : 'plaintiff';
  // stage bias: higher stages more likely to reverse? small chance
  if(stage===2 && Math.random() < 0.25) winner = (winner==='plaintiff'?'defendant':'plaintiff');
  if(stage===3 && Math.random() < 0.15) winner = (winner==='plaintiff'?'defendant':'plaintiff');

  let headline = '';
  let fullText = '';
  if(state.case){ 
    const court = stage===1 ? state.case.court : stage===2 ? 'é«˜ç­‰'+state.case.court : 'æœ€é«˜è£åˆ¤æ‰€';
    const judge = randName();
    if(state.case.title) {
      // build a formal-looking judgment (short)
      if(state.case.type === 'criminal'){
        headline = winner==='plaintiff'? 'è¢«å‘Šäººã‚’æœ‰ç½ªã¨ã™ã‚‹' : 'è¢«å‘Šäººã‚’ç„¡ç½ªã¨ã™ã‚‹';
      } else {
        headline = winner==='plaintiff'? 'åŸå‘Šã®è«‹æ±‚ã‚’ä¸€éƒ¨èªå®¹ã™ã‚‹' : 'åŸå‘Šã®è«‹æ±‚ã‚’æ£„å´ã™ã‚‹';
      }
      // compose a fuller fullText
      fullText = `ä»¤å’Œ${new Date().getFullYear()}å¹´ï¼ˆä»®ï¼‰ç¬¬${Math.floor(100+Math.random()*900)}å·\nã€€åŸå‘Šã€€${randName()}\nã€€è¢«å‘Šã€€${randName()}\n\nã€€${court}\n\nã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€åˆ¤ã€€ã€€æ±º\n\nä¸»æ–‡\n`;
      if(winner==='plaintiff'){
        if(state.case.type==='criminal') fullText += `è¢«å‘Šäººã‚’æ‡²å½¹${1+Math.floor(Math.random()*4)}å¹´ã«å‡¦ã™ã‚‹ã€‚`;
        else fullText += `è¢«å‘Šã¯åŸå‘Šã«å¯¾ã—é‡‘${(50000 + Math.floor(Math.random()*450000)).toLocaleString()}å††ã‚’æ”¯æ‰•ãˆã€‚è¨´è¨Ÿè²»ç”¨ã¯è¢«å‘Šã®è² æ‹…ã¨ã™ã‚‹ã€‚`;
      } else {
        if(state.case.type==='criminal') fullText += `è¢«å‘Šäººã‚’ç„¡ç½ªã¨ã™ã‚‹ã€‚`;
        else fullText += `åŸå‘Šã®è«‹æ±‚ã‚’æ£„å´ã™ã‚‹ã€‚`;
      }
      fullText += `\n\nç†ç”±\nç¬¬ï¼‘ã€€äº‹æ¡ˆã®æ¦‚è¦\nã€€${state.case.summary}\n\nç¬¬ï¼’ã€€å½“äº‹è€…ã®ä¸»å¼µ\nï¼‘ã€€åŸå‘Šï¼ˆåˆã¯æ¤œå¯Ÿï¼‰\nã€€ï¼ˆè¦æ—¨ï¼‰â€¦\nï¼’ã€€è¢«å‘Š\nã€€ï¼ˆè¦æ—¨ï¼‰â€¦\n\nç¬¬ï¼“ã€€å½“è£åˆ¤æ‰€ã®åˆ¤æ–­\nï¼‘ã€€äº‰ç‚¹ï¼ˆä¸»è¦ãªäº‰ç‚¹ï¼‰ã«ã¤ã„ã¦\nã€€ï¼ˆè¨¼æ‹ åŠã³åˆ¤æ–­ï¼‰â€¦\n\nã‚ˆã£ã¦ã€ä¸»æ–‡ã®ã¨ãŠã‚Šåˆ¤æ±ºã™ã‚‹ã€‚\n\nä»¤å’Œ${new Date().getFullYear()}å¹´${new Date().getMonth()+1}æœˆ${new Date().getDate()}æ—¥\nã€€${court}\nã€€è£åˆ¤å®˜ã€€${judge}`;
    } else {
      headline = 'åˆ¤æ±ºï¼ˆä»®ï¼‰';
      fullText = 'ï¼ˆåˆ¤æ±ºæœ¬æ–‡ï¼‰';
    }
  } else {
    headline = 'åˆ¤æ±ºï¼ˆä»®ï¼‰';
    fullText = 'ï¼ˆäº‹ä»¶æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰';
  }

  return {winner, headline, fullText};
}

/* render the trial area for a given stage (display last record and verdict) */
function renderTrialArea(stageNo){
  const area = $('trialArea');
  area.innerHTML = '';
  const card = document.createElement('div');
  card.style.padding='8px';
  card.style.borderRadius='8px';
  card.style.background='#fff';
  card.style.border='1px solid #eef6ff';
  const title = document.createElement('div');
  title.innerHTML = `<div class="stage-indicator">ç¬¬${stageNo}å¯©ï¼š${stageNo===1?'ç¬¬ä¸€å¯©ï¼ˆåœ°è£ï¼‰':stageNo===2?'æ§è¨´å¯©ï¼ˆé«˜è£ï¼‰':'ä¸Šå‘Šå¯©ï¼ˆæœ€é«˜è£ï¼‰'}</div>`;
  card.appendChild(title);

  // records
  const recs = state.records[stageNo] || [];
  const last = recs[recs.length-1];
  const recDiv = document.createElement('div');
  recDiv.style.marginTop='8px';
  recDiv.innerHTML = last ? `<div class="small">ç›´è¿‘æ‰‹ç¶š: ${last.step}</div>
    <div><strong>åŸå‘Šä¸»å¼µ</strong><div class="small">${last.outputs.plaintiff}</div></div>
    <div><strong>è¢«å‘Šä¸»å¼µ</strong><div class="small">${last.outputs.defendant}</div></div>
    <div><strong>è£åˆ¤æ‰€ãƒ¡ãƒ¢</strong><div class="small">${last.outputs.judgeNotes}</div></div>` : '<div class="small">ã¾ã æ‰‹ç¶šã¯é€²ã‚“ã§ã„ã¾ã›ã‚“ã€‚</div>';
  card.appendChild(recDiv);

  // verdict
  const v = state.verdicts[stageNo];
  const verdictDiv = document.createElement('div');
  verdictDiv.style.marginTop='10px';
  verdictDiv.innerHTML = v ? `<div><strong>åˆ¤æ±º:</strong> ${v.headline}</div>` : '<div class="small">åˆ¤æ±ºã¯æœªç¢ºå®šã§ã™</div>';
  card.appendChild(verdictDiv);

  // player prediction status
  const pred = state.player.predictions[stageNo];
  const predDiv = document.createElement('div');
  predDiv.style.marginTop='10px';
  predDiv.innerHTML = `<div class="small">ã‚ãªãŸã®ã“ã®å¯©ç´šã®äºˆæƒ³: ${pred ? (pred==='plaintiff'?'åŸå‘Šå‹è¨´':'è¢«å‘Šå‹è¨´') : 'æœªç™»éŒ²'}</div>`;
  card.appendChild(predDiv);

  area.appendChild(card);
}

/* update player log area */
function updatePlayerLog(){
  const el = $('playerLog');
  el.innerHTML = '';
  const lines = [];
  // actions grouped by stage
  (state.player.actions||[]).forEach((act,i)=> {
    const prefix = act.type==='objection' ? 'ç•°è­°ã‚ã‚Š' : 'æ„è¦‹';
    lines.push(`ç¬¬${act.stage}å¯© [${prefix}] ${act.text}`);
  });
  // predictions
  for(let s=1;s<=3;s++){
    if(state.player.predictions[s]) lines.push(`ç¬¬${s}å¯© äºˆæƒ³: ${state.player.predictions[s]==='plaintiff'?'åŸå‘Šå‹è¨´':'è¢«å‘Šå‹è¨´'}`);
  }
  el.innerText = lines.join('\n') || '(è¨˜éŒ²ãªã—)';
}

/* ---------- PDF generation (html2pdf) ---------- */
function exportAllVerdictsPDF(){
  if(!state.case){ alert('æœªã äº‹ä»¶ãŒã‚ã‚Šã¾ã›ã‚“'); return; }

  // construct printable DOM element
  const wrapper = document.createElement('div');
  wrapper.style.padding='18px';
  wrapper.style.fontFamily='"Noto Sans JP", sans-serif';
  wrapper.style.color='#111';
  wrapper.style.background='#fff';
  wrapper.style.width='780px'; // for decent layout when rasterized
  wrapper.style.boxSizing='border-box';

  // header
  const header = document.createElement('div');
  header.innerHTML = `<div style="text-align:right;font-size:12px">ä½œæˆ: ${now()}</div>
    <h2 style="text-align:center;margin:6px 0 12px 0">åˆ¤æ±ºæ›¸ï¼ˆå­¦ç¿’ç”¨ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰</h2>`;
  wrapper.appendChild(header);

  // case info
  const caseInfo = document.createElement('div');
  caseInfo.style.marginBottom='8px';
  caseInfo.innerHTML = `<div><strong>äº‹ä»¶ID:</strong> ${state.case.id || ''}</div>
    <div><strong>äº‹ä»¶å / è¦æ—¨:</strong> ${state.case.title} â€” ${state.case.summary}</div>
    <div><strong>è£åˆ¤æ‰€ï¼ˆç¬¬ä¸€å¯©åï¼‰ï¼š</strong> ${state.case.court}</div>`;
  wrapper.appendChild(caseInfo);

  // each stage fullText
  for(let s=1;s<=3;s++){
    const v = state.verdicts[s];
    const stageTitle = s===1 ? 'ç¬¬ä¸€å¯©ï¼ˆåœ°æ–¹è£åˆ¤æ‰€ï¼‰' : s===2 ? 'æ§è¨´å¯©ï¼ˆé«˜ç­‰è£åˆ¤æ‰€ï¼‰' : 'ä¸Šå‘Šå¯©ï¼ˆæœ€é«˜è£åˆ¤æ‰€ï¼‰';
    const container = document.createElement('div');
    container.style.marginTop='12px';
    container.innerHTML = `<h3 style="margin-bottom:6px">${stageTitle}</h3>`;
    if(v){
      // put full text (preserve newlines)
      const pre = document.createElement('pre');
      pre.style.whiteSpace='pre-wrap';
      pre.style.fontFamily='"Noto Sans JP", sans-serif';
      pre.style.fontSize='12px';
      pre.style.lineHeight='1.5';
      pre.style.background='transparent';
      pre.textContent = v.fullText;
      container.appendChild(pre);
    } else {
      container.innerHTML += `<div class="small">ï¼ˆåˆ¤æ±ºæœªç”Ÿæˆï¼‰</div>`;
    }
    // player's prediction for this stage
    const pred = state.player.predictions[s];
    container.innerHTML += `<div style="margin-top:6px"><strong>ã‚ãªãŸã®äºˆæƒ³:</strong> ${pred? (pred==='plaintiff'?'åŸå‘Šå‹è¨´':'è¢«å‘Šå‹è¨´') : 'æœªç™»éŒ²'}</div>`;
    // player's actions filtered by stage
    const acts = (state.player.actions||[]).filter(a=>a.stage===s);
    if(acts.length){
      const actsDiv = document.createElement('div');
      actsDiv.style.marginTop='6px';
      actsDiv.innerHTML = '<strong>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨˜éŒ²ï¼ˆã“ã®å¯©ç´šï¼‰:</strong>';
      const ul = document.createElement('ul');
      acts.forEach(a=> {
        const li = document.createElement('li');
        li.textContent = `[${a.type==='objection'?'ç•°è­°':'æ„è¦‹'}] ${a.text} (${new Date(a.time).toLocaleString()})`;
        ul.appendChild(li);
      });
      actsDiv.appendChild(ul);
      container.appendChild(actsDiv);
    }
    wrapper.appendChild(container);
  }

  // overall game result
  const summary = document.createElement('div');
  summary.style.marginTop='14px';
  const totalPreds = Object.keys(state.player.predictions).length;
  const hits = state.player.score;
  const percent = totalPreds? Math.round((hits/totalPreds)*100) : 0;
  summary.innerHTML = `<h3>ã€ã‚²ãƒ¼ãƒ çµæœã€‘</h3>
    <div>ãƒ»äºˆæƒ³ç™»éŒ²æ•°: ${totalPreds}</div>
    <div>ãƒ»çš„ä¸­æ•°: ${hits}</div>
    <div>ãƒ»çš„ä¸­ç‡: ${percent}%</div>`;
  wrapper.appendChild(summary);

  // all player actions (full, raw)
  const allActs = document.createElement('div');
  allActs.style.marginTop='12px';
  allActs.innerHTML = `<h3>ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å…¨ç™ºè¨€ãƒ­ã‚°ï¼ˆæ™‚ç³»åˆ—ï¼‰ã€‘</h3>`;
  if(state.player.actions.length){
    const pre2 = document.createElement('pre');
    pre2.style.whiteSpace='pre-wrap';
    pre2.style.fontFamily='"Noto Sans JP", sans-serif';
    pre2.style.fontSize='12px';
    pre2.textContent = state.player.actions.map((a,i)=>`${i+1}. ç¬¬${a.stage}å¯© [${a.type}] ${a.text} (${new Date(a.time).toLocaleString()})`).join('\\n');
    allActs.appendChild(pre2);
  } else allActs.innerHTML += '<div class="small">ï¼ˆè¨˜éŒ²ãªã—ï¼‰</div>';
  wrapper.appendChild(allActs);

  // generate PDF via html2pdf
  const opt = {
    margin: 12,
    filename: `åˆ¤æ±ºæ–‡_${(new Date()).toISOString().slice(0,10)}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'pt', format: 'a4', orientation: 'portrait' }
  };
  // show quick feedback
  log('PDFç”Ÿæˆä¸­â€¦ï¼ˆå°‘ã—æ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼‰');
  html2pdf().set(opt).from(wrapper).save().then(()=> {
    log('PDFã‚’å‡ºåŠ›ã—ã¾ã—ãŸ');
  }).catch(err=>{
    console.error(err);
    alert('PDFç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‚ç…§ï¼‰');
  });
}

/* ---------- initial state / helpers ---------- */
(function init(){
  // default example
  $('caseInput').value = 'è·¯ä¸Šè‡ªè»¢è»Šè¡çªäº‹ä»¶ â€” å¤œé–“æ¨ªæ–­ä¸­ã®æ­©è¡Œè€…ãŒè‡ªè»¢è»Šã¨è¡çªã—è² å‚·ã€‚åŸå‘Šã¯æå®³è³ å„Ÿ100ä¸‡å††ã‚’è«‹æ±‚ã€‚';
  renderTrialArea(1);
  setStage(0);
  updatePlayerLog();
})();
</script>
</body>
</html>
